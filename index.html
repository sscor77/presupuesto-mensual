<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Libro de Presupuesto Mensual — EverBudget (Prototipo)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6d28d9">
  <style>
    :root {
      --bg: #0f1724;
      --card: #1f2937;
      --muted: #9ca3af;
      --accent: #7c3aed;
      --accent-light: #8b5cf6;
      --text: #f3f4f6;
      --text-muted: #d1d5db;
      --danger: #ef4444;
      --success: #10b981;
      --input-bg: rgba(255, 255, 255, 0.07);
      --input-border: rgba(255, 255, 255, 0.1);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #071029 0%, #0f1724 100%);
      color: var(--text);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      line-height: 1.5;
    }
    
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      color: var(--text);
    }
    
    h2 {
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 16px;
      font-weight: 600;
      color: var(--text);
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
      margin-top: 16px;
    }
    
    .card {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-light);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }
    
    /* Estilos específicos para select */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 40px;
    }
    
    /* Estilos para las opciones del select */
    option {
      background: var(--card);
      color: var(--text);
      padding: 10px;
    }
    
    .row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .small {
      width: 140px;
    }
    
    button {
      background: var(--accent);
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    button:hover {
      background: var(--accent-light);
      transform: translateY(-1px);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 14px;
    }
    
    th {
      font-weight: 600;
      color: var(--text-muted);
      background: rgba(0, 0, 0, 0.2);
    }
    
    .muted {
      color: var(--muted);
    }
    
    .summary {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    
    .pill {
      padding: 16px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
      min-width: 120px;
      flex: 1;
    }
    
    .pill div:first-child {
      font-size: 13px;
      margin-bottom: 6px;
    }
    
    .pill div:last-child {
      font-size: 18px;
      font-weight: 600;
    }
    
    .danger {
      background: linear-gradient(180deg, rgba(239, 68, 68, 0.12), rgba(239, 68, 68, 0.08));
    }
    
    .success {
      background: linear-gradient(180deg, rgba(16, 185, 129, 0.12), rgba(16, 185, 129, 0.08));
    }
    
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .small-btn {
      padding: 8px 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.08);
      cursor: pointer;
      color: var(--text);
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .small-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }
    
    footer {
      margin-top: 40px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      padding: 20px 0;
    }
    
    .delete-btn {
      color: var(--danger);
      cursor: pointer;
      background: none;
      border: none;
      padding: 6px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .delete-btn:hover {
      color: #f87171;
      transform: scale(1.05);
    }
    
    #importFile {
      display: none;
    }
    
    .empty-state {
      text-align: center;
      padding: 30px 0;
      color: var(--muted);
    }
    
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .small {
        width: 100%;
      }
      
      .row {
        flex-direction: column;
        gap: 12px;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .controls {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Presupuesto Mensual — Prototipo (en español)</h1>
    <div class="controls">
      <button id="exportBtn" class="small-btn">Exportar JSON</button>
      <button id="importBtn" class="small-btn">Importar JSON</button>
      <button id="clearBtn" class="small-btn">Borrar todo</button>
    </div>
  </header>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="grid">
    <!-- Sección principal para agregar movimientos y listarlos -->
    <div>
      <div class="card">
        <h2>Agregar Movimiento</h2>
        <form id="transactionForm">
          <label>Descripción</label>
          <input type="text" id="description" required placeholder="Ej: Pago nómina">
          
          <div class="row">
            <div style="flex: 1;">
              <label>Monto</label>
              <input type="number" id="amount" required placeholder="0.00" step="0.01">
            </div>
            <div style="flex: 1;">
              <label>Tipo</label>
              <select id="type">
                <option value="ingreso">Ingreso</option>
                <option value="gasto">Gasto</option>
              </select>
            </div>
          </div>
          
          <div class="row">
            <div style="flex: 1;">
              <label>Fecha</label>
              <input type="date" id="date">
            </div>
            <div style="flex: 1;">
              <label>Categoría</label>
              <select id="category">
                <option value="nómina">Nómina</option>
                <option value="freelance">Freelance</option>
                <option value="otros">Otros ingresos</option>
                <option value="comida">Comida</option>
                <option value="transporte">Transporte</option>
                <option value="ocio">Ocio</option>
                <option value="servicios">Servicios</option>
                <option value="otros-gastos">Otros gastos</option>
              </select>
            </div>
          </div>
          
          <button type="submit" style="margin-top: 10px;">Agregar Movimiento</button>
        </form>
      </div>

      <div class="card">
        <h2>Movimientos Registrados</h2>
        <table id="transactionsTable">
          <thead>
            <tr>
              <th>Descripción</th>
              <th>Monto</th>
              <th>Tipo</th>
              <th>Fecha</th>
              <th>Categoría</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- Los movimientos se insertarán aquí dinámicamente -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Panel lateral con resumen -->
    <div>
      <div class="card">
        <h2>Resumen del Mes</h2>
        <div class="summary">
          <div class="pill">
            <div class="muted">Balance Total</div>
            <div id="balance">0,00 €</div>
          </div>
          <div class="pill success">
            <div class="muted">Ingresos</div>
            <div id="income">0,00 €</div>
          </div>
          <div class="pill danger">
            <div class="muted">Gastos</div>
            <div id="expense">0,00 €</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2>Filtros y Opciones</h2>
        <div class="row">
          <div style="flex: 1;">
            <label>Mes</label>
            <input type="month" id="monthFilter">
          </div>
          <div style="flex: 1;">
            <label>Categoría</label>
            <select id="categoryFilter">
              <option value="">Todas las categorías</option>
              <option value="nómina">Nómina</option>
              <option value="freelance">Freelance</option>
              <option value="otros">Otros ingresos</option>
              <option value="comida">Comida</option>
              <option value="transporte">Transporte</option>
              <option value="ocio">Ocio</option>
              <option value="servicios">Servicios</option>
              <option value="otros-gastos">Otros gastos</option>
            </select>
          </div>
        </div>
        <button id="applyFilters" class="small-btn" style="margin-top: 10px;">Aplicar Filtros</button>
      </div>
    </div>
  </div>

  <footer>Prototipo — funcionalidad básica con persistencia local (localStorage) y soporte PWA. Puedes pedirme adaptaciones: CSV, PDF o sincronización en la nube.</footer>
</div>

<input type="file" id="importFile" accept=".json">

<script>
// Registrar service worker para PWA
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sv.js").then(() => {
    console.log("Service Worker registrado correctamente.");
  }).catch(error => {
    console.log("Error registrando Service Worker:", error);
  });
}
</script>

<script>
// === CÓDIGO PRINCIPAL DE LA APLICACIÓN ===

// Variables globales
let transactions = [];
const transactionForm = document.getElementById('transactionForm');
const transactionsTable = document.getElementById('transactionsTable').getElementsByTagName('tbody')[0];
const balanceElement = document.getElementById('balance');
const incomeElement = document.getElementById('income');
const expenseElement = document.getElementById('expense');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const clearBtn = document.getElementById('clearBtn');
const applyFilters = document.getElementById('applyFilters');
const monthFilter = document.getElementById('monthFilter');
const categoryFilter = document.getElementById('categoryFilter');

// Inicializar la aplicación
document.addEventListener('DOMContentLoaded', function() {
  // Cargar transacciones desde localStorage
  loadTransactions();
  
  // Establecer fecha actual por defecto
  const today = new Date();
  document.getElementById('date').valueAsDate = today;
  
  // Establecer mes actual en el filtro
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  monthFilter.value = `${year}-${month}`;
  
  // Renderizar transacciones
  renderTransactions();
  updateSummary();
});

// Cargar transacciones desde localStorage
function loadTransactions() {
  const storedTransactions = localStorage.getItem('transactions');
  if (storedTransactions) {
    transactions = JSON.parse(storedTransactions);
  }
}

// Guardar transacciones en localStorage
function saveTransactions() {
  localStorage.setItem('transactions', JSON.stringify(transactions));
}

// Manejar envío del formulario
transactionForm.addEventListener('submit', function(e) {
  e.preventDefault();
  
  const description = document.getElementById('description').value;
  const amount = parseFloat(document.getElementById('amount').value);
  const type = document.getElementById('type').value;
  const date = document.getElementById('date').value;
  const category = document.getElementById('category').value;
  
  if (!description || isNaN(amount) || amount <= 0 || !date) {
    alert('Por favor, completa todos los campos correctamente.');
    return;
  }
  
  const transaction = {
    id: Date.now(), // ID único basado en timestamp
    description,
    amount,
    type,
    date,
    category
  };
  
  transactions.push(transaction);
  saveTransactions();
  renderTransactions();
  updateSummary();
  
  // Resetear formulario
  transactionForm.reset();
  document.getElementById('date').valueAsDate = new Date();
});

// Renderizar la lista de transacciones
function renderTransactions() {
  // Limpiar tabla
  transactionsTable.innerHTML = '';
  
  // Obtener valores de filtro
  const filterMonth = monthFilter.value;
  const filterCategory = categoryFilter.value;
  
  // Aplicar filtros
  let filteredTransactions = transactions;
  
  if (filterMonth) {
    filteredTransactions = filteredTransactions.filter(t => t.date.startsWith(filterMonth));
  }
  
  if (filterCategory) {
    filteredTransactions = filteredTransactions.filter(t => t.category === filterCategory);
  }
  
  // Ordenar por fecha (más reciente primero)
  filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // Mostrar transacciones
  if (filteredTransactions.length === 0) {
    const row = transactionsTable.insertRow();
    const cell = row.insertCell(0);
    cell.colSpan = 6;
    cell.innerHTML = '<div class="empty-state">No hay movimientos registrados</div>';
    return;
  }
  
  filteredTransactions.forEach(transaction => {
    const row = transactionsTable.insertRow();
    
    row.insertCell(0).textContent = transaction.description;
    row.insertCell(1).textContent = `${transaction.amount.toFixed(2)} €`;
    
    const typeCell = row.insertCell(2);
    typeCell.textContent = transaction.type === 'ingreso' ? 'Ingreso' : 'Gasto';
    typeCell.style.color = transaction.type === 'ingreso' ? '#10b981' : '#ef4444';
    typeCell.style.fontWeight = '500';
    
    row.insertCell(3).textContent = formatDate(transaction.date);
    row.insertCell(4).textContent = getCategoryName(transaction.category);
    
    const actionsCell = row.insertCell(5);
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Eliminar';
    deleteBtn.className = 'delete-btn';
    deleteBtn.onclick = () => deleteTransaction(transaction.id);
    actionsCell.appendChild(deleteBtn);
  });
}

// Formatear fecha para mostrar
function formatDate(dateString) {
  const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
  return new Date(dateString).toLocaleDateString('es-ES', options);
}

// Obtener nombre de categoría para mostrar
function getCategoryName(categoryKey) {
  const categories = {
    'nómina': 'Nómina',
    'freelance': 'Freelance',
    'otros': 'Otros ingresos',
    'comida': 'Comida',
    'transporte': 'Transporte',
    'ocio': 'Ocio',
    'servicios': 'Servicios',
    'otros-gastos': 'Otros gastos'
  };
  
  return categories[categoryKey] || categoryKey;
}

// Actualizar resumen con totals
function updateSummary() {
  let totalIncome = 0;
  let totalExpense = 0;
  
  // Aplicar filtros también al resumen
  const filterMonth = monthFilter.value;
  let filteredTransactions = transactions;
  
  if (filterMonth) {
    filteredTransactions = filteredTransactions.filter(t => t.date.startsWith(filterMonth));
  }
  
  filteredTransactions.forEach(transaction => {
    if (transaction.type === 'ingreso') {
      totalIncome += transaction.amount;
    } else {
      totalExpense += transaction.amount;
    }
  });
  
  const balance = totalIncome - totalExpense;
  
  balanceElement.textContent = `${balance.toFixed(2)} €`;
  incomeElement.textContent = `${totalIncome.toFixed(2)} €`;
  expenseElement.textContent = `${totalExpense.toFixed(2)} €`;
  
  // Colorear el balance según si es positivo o negativo
  balanceElement.style.color = balance >= 0 ? '#10b981' : '#ef4444';
}

// Eliminar transacción
function deleteTransaction(id) {
  if (confirm('¿Estás seguro de que quieres eliminar este movimiento?')) {
    transactions = transactions.filter(t => t.id !== id);
    saveTransactions();
    renderTransactions();
    updateSummary();
  }
}

// Exportar datos a JSON
exportBtn.addEventListener('click', function() {
  const dataStr = JSON.stringify(transactions, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `presupuesto-${new Date().toISOString().slice(0,10)}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
});

// Importar datos desde JSON
importBtn.addEventListener('click', function() {
  importFile.click();
});

importFile.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      
      if (Array.isArray(importedData)) {
        if (confirm(`¿Importar ${importedData.length} movimientos? Se reemplazarán los datos actuales.`)) {
          transactions = importedData;
          saveTransactions();
          renderTransactions();
          updateSummary();
          alert('Datos importados correctamente.');
        }
      } else {
        alert('El archivo no contiene datos válidos.');
      }
    } catch (error) {
      alert('Error al importar el archivo: ' + error.message);
    }
  };
  reader.readAsText(file);
  
  // Resetear input file
  importFile.value = '';
});

// Borrar todos los datos
clearBtn.addEventListener('click', function() {
  if (confirm('¿Estás seguro de que quieres borrar todos los datos? Esta acción no se puede deshacer.')) {
    transactions = [];
    saveTransactions();
    renderTransactions();
    updateSummary();
  }
});

// Aplicar filtros
applyFilters.addEventListener('click', function() {
  renderTransactions();
  updateSummary();
});
</script>
</body>
</html>
